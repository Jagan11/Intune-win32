name: Package Telegram for Intune

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: ğŸ“‚ Create directories
        run: |
          mkdir input
          mkdir output

      - name: ğŸ“¥ Download Telegram installer
        run: |
          Invoke-WebRequest -Uri "https://telegram.org/dl/desktop/win" -OutFile "input\TelegramSetup.exe"

      - name: ğŸ” Extract Telegram version
        id: get_version
        run: |
          $path = "input\TelegramSetup.exe"
          $version = (Get-Item $path).VersionInfo.ProductVersion
          if (-not $version) {
            Write-Error "âŒ Could not extract version from Telegram installer"
            exit 1
          }
          echo "TELEGRAM_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "âœ… Detected Telegram version: $version"

      - name: ğŸ“¥ Download IntuneWinAppUtil
        run: |
          Invoke-WebRequest -Uri "https://github.com/microsoft/Microsoft-Win32-Content-Prep-Tool/releases/latest/download/IntuneWinAppUtil.exe" -OutFile "IntuneWinAppUtil.exe"

      - name: ğŸ“¦ Package Telegram into .intunewin
        run: |
          .\IntuneWinAppUtil.exe -c input -s TelegramSetup.exe -o output -q
          $newName = "Telegram-win-x64-${{ env.TELEGRAM_VERSION }}.intunewin"
          Rename-Item "output\TelegramSetup.intunewin" $newName -Force

      - name: â¬†ï¸ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Telegram-Intune-Package
          path: output\*.intunewin
