name: Telegram Desktop (Windows) Intune App Package

on:
  workflow_dispatch:

jobs:
  package-telegram-desktop:
    runs-on: windows-latest

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üìÇ Create working directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path ".\input" -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path ".\output" -ErrorAction SilentlyContinue

      - name: üì• Download Telegram installer
        shell: pwsh
        run: |
          $installerUrl = "https://telegram.org/dl/desktop/win"
          $outputFile = ".\input\TelegramDesktopSetup.exe"
          Invoke-WebRequest -Uri $installerUrl -OutFile $outputFile -MaximumRedirection 5
          if (-not (Test-Path $outputFile)) { throw "Download failed: Installer not found" }
          $fileSize = (Get-Item $outputFile).Length
          if ($fileSize -lt 50000000) {
            Write-Warning "Downloaded installer size is suspiciously small."
          }

      - name: üîé Extract Telegram version
        id: get_version
        shell: pwsh
        run: |
          $installer = ".\input\TelegramDesktopSetup.exe"
          $version = (Get-Item $installer).VersionInfo.ProductVersion
          if (-not $version) { throw "Could not extract Telegram version" }
          echo "TELEGRAM_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: üì• Download IntuneWinAppUtil
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/microsoft/Microsoft-Win32-Content-Prep-Tool/raw/2d0afcf7c1faf9c0f7dbd6db9c90b19f5dfec994/IntuneWinAppUtil.exe" -OutFile "IntuneWinAppUtil.exe"
          if (-not (Test-Path ".\IntuneWinAppUtil.exe")) { throw "Failed to download IntuneWinAppUtil.exe" }

      - name: üì¶ Package Telegram into .intunewin
        shell: pwsh
        run: |
          & ".\IntuneWinAppUtil.exe" -c ".\input" -s "TelegramDesktopSetup.exe" -o ".\output" -q
          $version = $env:TELEGRAM_VERSION
          $intunewin = Get-ChildItem -Path ".\output" -Filter "*.intunewin" | Select-Object -First 1
          if (-not $intunewin) { throw ".intunewin file not found in output folder" }
          # Correct rename - specify only new file name, not path
          Rename-Item -Path $intunewin.FullName -NewName "Telegram-win-x64-$version.intunewin" -Force
          echo "TELEGRAM_INTUNEWIN_PATH=.\output\Telegram-win-x64-$version.intunewin" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: ‚¨ÜÔ∏è Upload Telegram .intunewin package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Telegram-Intune-Package
          path: output/*.intunewin
          retention-days: 7

      - name: üßπ Clean up temporary directories
