name: Package Telegram for Intune

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: üìÇ Create directories
        run: |
          mkdir input
          mkdir output

      - name: üì• Download Telegram installer
        run: |
          Invoke-WebRequest -Uri "https://telegram.org/dl/desktop/win" -OutFile "input\TelegramSetup.exe"

      - name: üîé Extract Telegram version
        id: get_version
        run: |
          $path = "input\TelegramSetup.exe"
          $version = (Get-Item $path).VersionInfo.ProductVersion
          if (-not $version) {
            Write-Error "‚ùå Could not extract version from Telegram installer"
            exit 1
          }
          echo "TELEGRAM_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "‚úÖ Detected Telegram version: $version"

      - name: üì• Download IntuneWinAppUtil
        run: |
          Invoke-WebRequest -Uri "https://github.com/microsoft/Microsoft-Win32-Content-Prep-Tool/releases/latest/download/IntuneWinAppUtil.exe" -OutFile "IntuneWinAppUtil.exe"

      - name: üì¶ Package Telegram into .intunewin
        run: |
          .\IntuneWinAppUtil.exe -c input -s TelegramSetup.exe -o output -q
          $newName = "Telegram-win-x64-${{ env.TELEGRAM_VERSION }}.intunewin"
          Rename-Item "output\TelegramSetup.intunewin" $newName -Force

      - name: üìù Generate detection info
        run: |
          $version = "${{ env.TELEGRAM_VERSION }}"
          $content = @"
App: Telegram Desktop
Version: $version
Install command: TelegramSetup.exe /silent
Uninstall command: "%LocalAppData%\Telegram Desktop\uninstall.exe" /S
Detection rule: File exists at %LocalAppData%\Telegram Desktop\Telegram.exe
"@
          $content | Out-File -FilePath "output\Telegram_detection_info.txt" -Encoding utf8
          echo "‚úÖ Detection info file generated"

      - name: ‚¨ÜÔ∏è Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Telegram-Intune-Package
          path: |
            output\*.intunewin
            output\Telegram_detection_info.txt
