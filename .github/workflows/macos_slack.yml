name: Package Slack macOS .intunemac

on:
  workflow_dispatch:

jobs:
  package-slack:
    runs-on: macos-latest
    steps:
      - name: Create base directories
        run: |
          mkdir -p output
          mkdir -p tools
          mkdir -p temp_app_dir # Directory to hold the extracted .app

      - name: Checkout repository (not strictly needed for IntuneAppUtil anymore, but good practice)
        uses: actions/checkout@v3

      - name: Download Microsoft Shell Intune App Utility
        run: |
          set -eux
          echo "Downloading Microsoft Shell Intune App Utility (IntuneAppUtil) directly..."
          # Ensure the 'tools' directory exists right before attempting to download into it
          mkdir -p tools
          
          # Corrected URL: changed 'master' to 'main' branch
          curl -L "https://raw.githubusercontent.com/microsoft/shell-intune-samples/main/macOS/Tools/IntuneAppUtil" -o "$(pwd)/tools/IntuneAppUtil"
          
          # Make the downloaded file executable using its absolute path
          chmod +x "$(pwd)/tools/IntuneAppUtil"
          
          echo "IntuneAppUtil prepared."

      - name: Download latest Slack macOS DMG
        run: |
          set -eux # Added set -eux for this block too
          echo "Downloading latest Slack DMG..."
          # Ensure the 'input' directory exists right before attempting to download into it
          mkdir -p input
          
          # Use a direct link to the latest stable Slack DMG
          # This URL is more reliable than the ssb/download-osx redirect
          # Using an absolute path for the output file.
          curl -L "https://downloads.slack-edge.com/releases/macos/Slack-latest.dmg" -o "$(pwd)/input/Slack-latest.dmg"
          echo "Downloaded Slack DMG to input/Slack-latest.dmg"

      - name: Extract Slack.app from DMG and get version
        run: |
          set -eux
          DMG_PATH="$(pwd)/input/Slack-latest.dmg" # Use absolute path
          APP_NAME="Slack.app" # Expected name of the application bundle inside the DMG
          
          echo "Attaching DMG for Slack.app extraction..."
          # Attach the DMG, allowing it to be mounted
          MOUNT_OUTPUT=$(hdiutil attach "$DMG_PATH" -nobrowse -noverify)
          echo "hdiutil attach output:"
          echo "$MOUNT_OUTPUT"

          # Extract the mount point, robustly handling spaces in the volume name
          MOUNTPOINT=$(echo "$MOUNT_OUTPUT" | grep '/Volumes/' | head -n 1 | sed -E 's/.*(\/Volumes\/.*)/\1/')
          echo "Mounted DMG at: $MOUNTPOINT"

          if [ -z "$MOUNTPOINT" ]; then
            echo "Error: Could not find mount point for Slack DMG."
            exit 1
          fi

          # Copy the .app bundle to a temporary directory for packaging
          echo "Copying $APP_NAME from DMG to temporary directory..."
          cp -R "$MOUNTPOINT/$APP_NAME" "temp_app_dir/$APP_NAME"
          echo "$APP_NAME copied."

          # Read the CFBundleShortVersionString from the copied Slack.app's Info.plist
          VERSION=$(defaults read "temp_app_dir/$APP_NAME/Contents/Info.plist" CFBundleShortVersionString || echo "unknown")
          echo "SLACK_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Slack version: $VERSION"

          echo "Detaching DMG..."
          hdiutil detach "$MOUNTPOINT" -quiet
          echo "DMG detached."

      - name: Create .intunemac package using IntuneAppUtil
        run: |
          set -eux
          # Run the IntuneAppUtil on the extracted Slack.app
          # Output to the 'output' directory with a versioned name
          ./tools/IntuneAppUtil -c "temp_app_dir" -o "output" -n "Slack-macOS-$SLACK_VERSION.intunemac"
          echo "Slack-macOS-$SLACK_VERSION.intunemac created."

      - name: Upload .intunemac artifact
        uses: actions/upload-artifact@v4
        with:
          name: slack-macos-intunemac
          path: output/*.intunemac
          retention-days: 7
