name: MacOS Build Telegram Desktop

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          brew update
          brew install qt@5 pkgconf cmake

      - name: Build Telegram Desktop
        env:
          PATH: /opt/homebrew/opt/qt@5/bin:${{ env.PATH }}
          LDFLAGS: -L/opt/homebrew/opt/qt@5/lib
          CPPFLAGS: -I/opt/homebrew/opt/qt@5/include
          PKG_CONFIG_PATH: /opt/homebrew/opt/qt@5/lib/pkgconfig
        run: |
          cd tdesktop
          mkdir -p build
          cd build
          cmake .. -DCMAKE_PREFIX_PATH=/opt/homebrew/opt/qt@5
          make -j$(sysctl -n hw.ncpu)

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: telegram-macos-app
          path: tdesktop/build/
          retention-days: 7
