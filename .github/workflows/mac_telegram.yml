name: Build and Package Telegram Desktop macOS

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: Clone Telegram Desktop repo
        run: |
          git clone --depth 1 https://github.com/telegramdesktop/tdesktop.git

      - name: Install dependencies
        run: |
          brew install qt@5 cmake pkg-config create-dmg
          echo 'export PATH="/opt/homebrew/opt/qt@5/bin:$PATH"' >> $GITHUB_ENV
          echo 'export LDFLAGS="-L/opt/homebrew/opt/qt@5/lib"' >> $GITHUB_ENV
          echo 'export CPPFLAGS="-I/opt/homebrew/opt/qt@5/include"' >> $GITHUB_ENV
          echo 'export PKG_CONFIG_PATH="/opt/homebrew/opt/qt@5/lib/pkgconfig"' >> $GITHUB_ENV

      - name: Build Telegram Desktop
        env:
          PATH: /opt/homebrew/opt/qt@5/bin:${{ env.PATH }}
          LDFLAGS: -L/opt/homebrew/opt/qt@5/lib
          CPPFLAGS: -I/opt/homebrew/opt/qt@5/include
          PKG_CONFIG_PATH: /opt/homebrew/opt/qt@5/lib/pkgconfig
        run: |
          cd tdesktop
          mkdir -p build
          cd build
          cmake .. -DCMAKE_PREFIX_PATH=/opt/homebrew/opt/qt@5
          make -j$(sysctl -n hw.ncpu)

      - name: Create DMG installer
        run: |
          cd tdesktop/build
          create-dmg \
            --volname "Telegram Desktop" \
            --volicon Telegram.app/Contents/Resources/telegram.icns \
            --background none \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon Telegram.app 175 120 \
            --hide-extension Telegram.app \
            --app-drop-link 425 120 \
            Telegram.dmg Telegram.app

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: telegram-macos-dmg
          path: tdesktop/build/Telegram.dmg
